<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Budgetin</title>
  <script src="https://www.gstatic.com/charts/loader.js"></script>
  <style>
    /* ---------------------------------------------------------------------- */
    /* 1. DEFINISI TEMA */
    /* ---------------------------------------------------------------------- */
    
    /* DEFAULT THEME: HIJAU-PUTIH (Light Soft Theme) */
    :root {
      /* Warna Dasar Tema Hijau-Putih (Light Soft) */
      --color-white-bg: #FFFFFF; /* Putih Hangat */
      --color-light-bg: #FAF9F6; /* Krem Sangat Muda (Soft BG) */
      --color-dark-text: #333333; /* Hitam Soft */
      --color-green-primary: #7CD18B; /* Hijau Soft Utama (Aksen/Income) */
      --color-red-expense: #F0939A; /* Merah Muda Soft (Expense) */
      --color-border-classic: #E0E0E0; /* Border Soft */
      --color-balance-blue: #8AB8DE; /* Biru Soft */
      --color-header-green: #6AA573; /* Header Green Soft (Kontras Cukup) */

      /* Mapping ke Variabel Aplikasi */
      --bg-color: var(--color-light-bg);
      --card-bg: var(--color-white-bg);
      --text-color: var(--color-dark-text);
      --primary-color: var(--color-green-primary);
      --expense-color: var(--color-red-expense);
      --income-color: var(--color-green-primary);
      --balance-color: var(--color-balance-blue);
      --border-color: var(--color-border-classic);
      --header-color: var(--color-header-green);
      --modal-bg: rgba(0, 0, 0, 0.4);
      --tab-inactive-bg: #F0F0F0;
      
      /* Chart Theme */
      --chart-bg: var(--color-white-bg);
      --chart-text: var(--color-dark-text);
      
      /* Font */
      font-family: Arial, sans-serif;
    }

    /* DARK THEME (Optional: Jika user mengaktifkan dark mode) */
    @media (prefers-color-scheme: dark) {
      :root {
        --color-white-bg: #1e1e1e; /* Dark Gray */
        --color-light-bg: #121212; /* Very Dark Gray */
        --color-dark-text: #EAEAEA; /* Light Gray */
        --color-green-primary: #81C784; /* Light Green */
        --color-red-expense: #E57373; /* Light Red */
        --color-border-classic: #333333; /* Dark Border */
        --color-balance-blue: #64B5F6; /* Light Blue */
        --color-header-green: #388E3C; /* Darker Green */

        /* Mapping ke Variabel Aplikasi */
        --bg-color: var(--color-light-bg);
        --card-bg: var(--color-white-bg);
        --text-color: var(--color-dark-text);
        --primary-color: var(--color-green-primary);
        --expense-color: var(--color-red-expense);
        --income-color: var(--color-green-primary);
        --balance-color: var(--color-balance-blue);
        --border-color: var(--color-border-classic);
        --header-color: var(--color-header-green);
        --modal-bg: rgba(255, 255, 255, 0.1);
        --tab-inactive-bg: #222222;

        /* Chart Theme */
        --chart-bg: var(--color-white-bg);
        --chart-text: var(--color-dark-text);
      }
    }

    /* ---------------------------------------------------------------------- */
    /* 2. STYLING DASAR */
    /* ---------------------------------------------------------------------- */

    body {
      background-color: var(--bg-color);
      color: var(--text-color);
      margin: 0;
      padding: 0;
      line-height: 1.6;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px 15px;
    }

    .card {
      background-color: var(--card-bg);
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      padding: 20px;
      margin-bottom: 20px;
      border: 1px solid var(--border-color);
    }

    h1, h2, h3 {
      color: var(--text-color);
      margin-top: 0;
    }

    /* ---------------------------------------------------------------------- */
    /* 3. STYLING INPUT & BUTTON */
    /* ---------------------------------------------------------------------- */
    
    .form-group {
        margin-bottom: 15px;
    }

    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
        font-size: 0.9em;
    }

    input[type="text"],
    input[type="number"],
    input[type="date"],
    select {
        width: 100%;
        padding: 10px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        box-sizing: border-box;
        background-color: var(--card-bg);
        color: var(--text-color);
        font-size: 1em;
        transition: border-color 0.3s;
    }
    
    input[type="text"]:focus,
    input[type="number"]:focus,
    input[type="date"]:focus,
    select:focus {
        border-color: var(--primary-color);
        outline: none;
    }
    
    button {
        padding: 10px 15px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        transition: background-color 0.3s, opacity 0.3s;
    }

    .btn-primary {
        background-color: var(--primary-color);
        color: var(--color-white-bg);
    }
    
    .btn-primary:hover:not(:disabled) {
        background-color: #6AA573; /* Sedikit lebih gelap */
    }

    .btn-expense {
        background-color: var(--expense-color);
        color: var(--color-white-bg);
    }
    .btn-expense:hover:not(:disabled) {
        background-color: #D67C83; 
    }

    .btn-income {
        background-color: var(--income-color);
        color: var(--color-white-bg);
    }
    .btn-income:hover:not(:disabled) {
        background-color: #6AA573; 
    }
    
    button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    /* ---------------------------------------------------------------------- */
    /* 4. HEADER & NAVIGASI */
    /* ---------------------------------------------------------------------- */

    header {
      background-color: var(--header-color);
      color: var(--color-white-bg);
      padding: 15px 0;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    header .container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-top: 0;
        padding-bottom: 0;
    }

    header h1 {
        color: var(--color-white-bg);
        margin: 0;
        font-size: 1.5em;
    }

    .nav-link {
        color: var(--color-white-bg);
        text-decoration: none;
        margin-left: 15px;
        font-weight: bold;
        opacity: 0.8;
        transition: opacity 0.3s;
    }

    .nav-link:hover {
        opacity: 1;
    }
    
    .nav-link.active {
        border-bottom: 2px solid var(--color-white-bg);
        opacity: 1;
    }
    
    /* Tombol Setting */
    .settings-button {
        background: none;
        border: none;
        color: var(--color-white-bg);
        font-size: 1.5em;
        cursor: pointer;
        padding: 0;
        margin-left: 15px;
        opacity: 0.8;
    }
    
    .settings-button:hover {
        opacity: 1;
    }


    /* ---------------------------------------------------------------------- */
    /* 5. TABS */
    /* ---------------------------------------------------------------------- */
    
    .tab-nav {
        display: flex;
        margin-bottom: 15px;
        border-bottom: 1px solid var(--border-color);
    }

    .tab-button {
        flex-grow: 1;
        padding: 12px 10px;
        text-align: center;
        background-color: var(--tab-inactive-bg);
        border: 1px solid var(--border-color);
        border-bottom: none;
        cursor: pointer;
        font-weight: bold;
        transition: background-color 0.3s, color 0.3s;
        border-top-left-radius: 8px;
        border-top-right-radius: 8px;
        margin-right: 5px;
    }

    .tab-button.active {
        background-color: var(--card-bg);
        color: var(--primary-color);
        border-bottom: 1px solid var(--card-bg); /* Menutupi border */
    }

    /* ---------------------------------------------------------------------- */
    /* 6. STATISTIK & TRANSAKSI */
    /* ---------------------------------------------------------------------- */

    .period-selector {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .period-display {
        font-size: 1.2em;
        font-weight: bold;
    }

    .period-nav button {
        background: none;
        color: var(--text-color);
        border: 1px solid var(--border-color);
        padding: 5px 10px;
        margin: 0 5px;
        border-radius: 4px;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 15px;
        text-align: center;
        margin-bottom: 20px;
    }

    .stat-box {
        padding: 15px 10px;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        background-color: var(--bg-color);
    }
    
    .stat-box h4 {
        margin-top: 0;
        font-size: 0.9em;
        opacity: 0.7;
    }

    .stat-income {
        color: var(--income-color);
    }
    .stat-expense {
        color: var(--expense-color);
    }
    .stat-balance {
        color: var(--balance-color);
    }
    
    .transaction-list {
        margin-top: 15px;
    }

    .transaction-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 0;
        border-bottom: 1px solid var(--border-color);
        cursor: pointer;
    }

    .transaction-item:hover {
        background-color: rgba(0, 0, 0, 0.02);
    }
    
    .transaction-item:last-child {
        border-bottom: none;
    }

    .trans-details {
        flex-grow: 1;
        margin-right: 10px;
    }

    .trans-category {
        font-weight: bold;
        font-size: 0.95em;
    }

    .trans-desc {
        font-size: 0.8em;
        opacity: 0.7;
    }

    .trans-date {
        font-size: 0.75em;
        opacity: 0.5;
        margin-top: 2px;
    }

    .trans-amount {
        font-weight: bold;
        white-space: nowrap;
    }

    .trans-expense .trans-amount {
        color: var(--expense-color);
    }

    .trans-income .trans-amount {
        color: var(--income-color);
    }
    
    .trans-empty {
        text-align: center;
        padding: 40px 0;
        opacity: 0.6;
    }


    /* ---------------------------------------------------------------------- */
    /* 7. MODAL (Pop-up) */
    /* ---------------------------------------------------------------------- */
    
    .modal {
        display: none; /* Default: Sembunyikan */
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: var(--modal-bg);
        backdrop-filter: blur(3px);
    }

    .modal-content {
        background-color: var(--card-bg);
        margin: 10% auto; /* Tengah vertikal dan horizontal */
        padding: 25px;
        border-radius: 12px;
        width: 90%; 
        max-width: 500px;
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
    }
    
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 10px;
    }

    .close-btn {
        color: var(--text-color);
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        opacity: 0.6;
    }

    .close-btn:hover,
    .close-btn:focus {
        opacity: 1;
    }
    
    .modal-actions {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 20px;
    }
    
    .modal-actions .btn-delete {
        background-color: #f44336;
        color: var(--color-white-bg);
    }
    .modal-actions .btn-delete:hover {
        background-color: #d32f2f;
    }
    
    /* ---------------------------------------------------------------------- */
    /* 8. ALERTS & NOTIFICATION */
    /* ---------------------------------------------------------------------- */
    
    #notification {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background-color: var(--header-color);
        color: var(--color-white-bg);
        padding: 12px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        z-index: 1001;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.5s, visibility 0.5s;
    }

    #notification.show {
        opacity: 1;
        visibility: visible;
    }
    
    /* ---------------------------------------------------------------------- */
    /* 9. SETTINGS UI */
    /* ---------------------------------------------------------------------- */

    .settings-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
    }

    .settings-list {
        list-style: none;
        padding: 0;
    }

    .settings-list-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid var(--border-color);
    }
    
    .settings-list-item:last-child {
        border-bottom: none;
    }

    .settings-list-item button {
        background-color: #f44336;
        color: var(--color-white-bg);
        padding: 5px 10px;
        font-size: 0.8em;
    }

    .settings-list-item button:hover {
        background-color: #d32f2f;
    }
    
    /* Budget Table */
    .budget-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
    }

    .budget-table th, .budget-table td {
        padding: 10px;
        text-align: left;
        border-bottom: 1px solid var(--border-color);
    }

    .budget-table th {
        font-size: 0.9em;
        background-color: var(--tab-inactive-bg);
    }

    .budget-table tr:last-child td {
        border-bottom: none;
    }
    
    .budget-limit-input {
        width: 80px;
        padding: 5px;
        font-size: 0.9em;
    }
    
    .budget-status-bar {
        height: 8px;
        background-color: var(--border-color);
        border-radius: 4px;
        overflow: hidden;
        margin-top: 5px;
    }

    .budget-status-fill {
        height: 100%;
        transition: width 0.5s;
    }

    .budget-status-fill.ok {
        background-color: var(--income-color);
    }
    
    .budget-status-fill.warning {
        background-color: orange;
    }
    
    .budget-status-fill.over {
        background-color: var(--expense-color);
    }

    /* ---------------------------------------------------------------------- */
    /* 10. RESPONSIVITAS */
    /* ---------------------------------------------------------------------- */

    @media (max-width: 600px) {
        .stats-grid {
            grid-template-columns: 1fr; /* Kolom tunggal pada HP */
        }
        
        .tab-button {
            padding: 10px 5px;
            font-size: 0.9em;
        }

        .settings-grid {
            grid-template-columns: 1fr;
        }
    }

  </style>
</head>
<body>

  <header>
    <div class="container">
      <h1 id="appTitle">Budgetin</h1>
      <div class="nav-bar">
        <button class="settings-button" onclick="openSettingsModal()">
            ⚙️
        </button>
      </div>
    </div>
  </header>

  <div class="container">

    <div class="tab-nav">
      <button class="tab-button active" data-tab="dashboard" onclick="changeTab('dashboard')">Dashboard</button>
      <button class="tab-button" data-tab="transaction" onclick="changeTab('transaction')">Transaksi</button>
      <button class="tab-button" data-tab="chart" onclick="changeTab('chart')">Laporan</button>
    </div>

    <div id="dashboard" class="tab-content">
      
      <div class="card">
        <h3>Periode</h3>
        <div class="period-selector">
          <div class="period-nav">
            <button onclick="changePeriod(-1)">Prev</button>
          </div>
          <div class="period-display" id="currentPeriodDisplay">Loading...</div>
          <div class="period-nav">
            <button onclick="changePeriod(1)">Next</button>
          </div>
        </div>
      </div>
      
      <div class="card">
        <h3>Ringkasan Keuangan</h3>
        <div class="stats-grid" id="statsGrid">
          <div class="stat-box stat-income">
            <h4>Pemasukan</h4>
            <div id="totalIncome" class="stat-amount">Rp 0</div>
          </div>
          <div class="stat-box stat-expense">
            <h4>Pengeluaran</h4>
            <div id="totalExpense" class="stat-amount">Rp 0</div>
          </div>
          <div class="stat-box stat-balance">
            <h4>Saldo Bersih</h4>
            <div id="netBalance" class="stat-amount">Rp 0</div>
          </div>
        </div>
      </div>
      
      <div class="card">
        <h3>Transaksi Terbaru <span class="trans-count-label" id="transCountLabel"></span></h3>
        <div class="transaction-list" id="latestTransactionList">
          <div class="trans-empty">Memuat transaksi...</div>
        </div>
      </div>

    </div>

    <div id="transaction" class="tab-content" style="display: none;">
      
      <div class="card">
        <h3>Tambah Transaksi Baru</h3>
        <div class="tab-nav" style="margin-bottom: 20px;">
          <button class="tab-button btn-expense active" data-form="expense-form" onclick="changeForm('expense-form')">Pengeluaran</button>
          <button class="tab-button btn-income" data-form="income-form" onclick="changeForm('income-form')">Pemasukan</button>
        </div>
        
        <form id="expense-form">
            <div class="form-group">
                <label for="expDate">Tanggal</label>
                <input type="date" id="expDate" required>
            </div>
            <div class="form-group">
                <label for="expCategory">Kategori</label>
                <select id="expCategory" required></select>
            </div>
            <div class="form-group">
                <label for="expAccount">Akun/Bank</label>
                <select id="expAccount" required></select>
            </div>
            <div class="form-group">
                <label for="expAmount">Jumlah</label>
                <input type="number" id="expAmount" placeholder="Contoh: 50000" min="1" required>
            </div>
            <div class="form-group">
                <label for="expDesc">Deskripsi (Opsional)</label>
                <input type="text" id="expDesc" maxlength="100">
            </div>
            <button type="submit" class="btn-expense" id="expSubmitBtn">Catat Pengeluaran</button>
        </form>
        
        <form id="income-form" style="display: none;">
            <div class="form-group">
                <label for="incDate">Tanggal</label>
                <input type="date" id="incDate" required>
            </div>
            <div class="form-group">
                <label for="incSource">Sumber Pemasukan</label>
                <select id="incSource" required></select>
            </div>
            <div class="form-group">
                <label for="incAccount">Akun/Bank Tujuan</label>
                <select id="incAccount" required></select>
            </div>
            <div class="form-group">
                <label for="incAmount">Jumlah</label>
                <input type="number" id="incAmount" placeholder="Contoh: 500000" min="1" required>
            </div>
            <div class="form-group">
                <label for="incDesc">Deskripsi (Opsional)</label>
                <input type="text" id="incDesc" maxlength="100">
            </div>
            <button type="submit" class="btn-income" id="incSubmitBtn">Catat Pemasukan</button>
        </form>
      </div>
      
      <div class="card">
        <h3>Semua Transaksi Bulan Ini</h3>
        <div class="period-selector">
          <div class="period-nav">
            <button onclick="changePeriod(-1, true)">Prev</button>
          </div>
          <div class="period-display" id="transPeriodDisplay">Loading...</div>
          <div class="period-nav">
            <button onclick="changePeriod(1, true)">Next</button>
          </div>
        </div>
        
        <div class="transaction-list" id="allTransactionList">
          <div class="trans-empty">Memuat transaksi...</div>
        </div>
      </div>
      
    </div>

    <div id="chart" class="tab-content" style="display: none;">
        <div class="card">
            <h3>Budget Bulanan</h3>
            <div class="period-selector" style="margin-bottom: 5px;">
              <div class="period-nav">
                <button onclick="changePeriod(-1, false, true)">Prev</button>
              </div>
              <div class="period-display" id="budgetPeriodDisplay">Loading...</div>
              <div class="period-nav">
                <button onclick="changePeriod(1, false, true)">Next</button>
              </div>
            </div>
            <div id="budgetTableContainer">
                <div class="trans-empty">Memuat Budget...</div>
            </div>
        </div>
        
        <div class="card">
            <h3>Tren Bulanan</h3>
            <div id="chartMonthly" style="width: 100%; height: 300px;"></div>
        </div>
        
        <div class="card">
            <h3>Proporsi Pengeluaran</h3>
            <div id="pieChartExpense" style="width: 100%; height: 300px;"></div>
        </div>
        
        <div class="card">
            <h3>Proporsi Pemasukan</h3>
            <div id="pieChartIncome" style="width: 100%; height: 300px;"></div>
        </div>
    </div>
    
  </div> <div id="editModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTitle">Edit Transaksi</h3>
            <span class="close-btn" onclick="closeModal('editModal')">&times;</span>
        </div>
        <form id="editTransactionForm">
            <input type="hidden" id="editTransId">
            <input type="hidden" id="editTransSheetName">
            
            <div class="form-group">
                <label for="editDate">Tanggal</label>
                <input type="date" id="editDate" required>
            </div>
            <div class="form-group">
                <label for="editCategory">Kategori/Sumber</label>
                <select id="editCategory" required></select>
            </div>
            <div class="form-group">
                <label for="editAccount">Akun/Bank</label>
                <select id="editAccount" required></select>
            </div>
            <div class="form-group">
                <label for="editAmount">Jumlah</label>
                <input type="number" id="editAmount" min="1" required>
            </div>
            <div class="form-group">
                <label for="editDesc">Deskripsi (Opsional)</label>
                <input type="text" id="editDesc" maxlength="100">
            </div>
            
            <div class="modal-actions">
                <button type="button" class="btn-delete" onclick="deleteTransaction()">Hapus</button>
                <button type="submit" class="btn-primary">Simpan Perubahan</button>
            </div>
        </form>
    </div>
  </div>
  
  <div id="settingsModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Pengaturan Aplikasi</h3>
            <span class="close-btn" onclick="closeModal('settingsModal')">&times;</span>
        </div>
        
        <div class="settings-grid">
            
            <div>
                <h4>Kategori Pengeluaran</h4>
                <div class="form-group" style="display: flex; gap: 5px;">
                    <input type="text" id="newExpCategory" placeholder="Kategori Baru">
                    <button class="btn-primary" onclick="addCategory('Expense')">Tambah</button>
                </div>
                <ul id="expenseCategoryList" class="settings-list"></ul>
                
                <h4 style="margin-top: 20px;">Sumber Pemasukan</h4>
                <div class="form-group" style="display: flex; gap: 5px;">
                    <input type="text" id="newIncSource" placeholder="Sumber Baru">
                    <button class="btn-primary" onclick="addCategory('Income')">Tambah</button>
                </div>
                <ul id="incomeSourceList" class="settings-list"></ul>
            </div>
            
            <div>
                <h4>Akun/Bank</h4>
                <div class="form-group" style="display: flex; gap: 5px;">
                    <input type="text" id="newAccountName" placeholder="Nama Akun Baru">
                    <button class="btn-primary" onclick="addAccount()">Tambah</button>
                </div>
                <ul id="accountList" class="settings-list"></ul>
            </div>
            
        </div>
        
    </div>
  </div>
  
  <div id="notification"></div>


  <script>
    // ----------------------------------------------------------------------
    // 1. KONFIGURASI DAN GLOBAL STATE
    // ----------------------------------------------------------------------
    
    // ** PENTING: GANTI DENGAN URL WORKER ANDA **
    // Contoh: 'https://money-flow-api.yourusername.workers.dev' atau URL Pages Anda
    const API_BASE_URL = "https://bellanovitadona.budgetin.workers.dev/"; 
    
    let currentPeriod = ''; // Format YYYY-MM
    let allCategories = { categories: [], sources: [], accounts: [] };
    
    // Konstanta Warna
    const expenseColor = getComputedStyle(document.documentElement).getPropertyValue('--expense-color').trim();
    const incomeColor = getComputedStyle(document.documentElement).getPropertyValue('--income-color').trim();
    const balanceColor = getComputedStyle(document.documentElement).getPropertyValue('--balance-color').trim();
    const chartBg = getComputedStyle(document.documentElement).getPropertyValue('--chart-bg').trim();
    const chartText = getComputedStyle(document.documentElement).getPropertyValue('--chart-text').trim();
    
    // ----------------------------------------------------------------------
    // 2. API CALL HELPER (PENGGANTI google.script.run)
    // ----------------------------------------------------------------------

    const api = {
        /**
         * Mengambil data dari Worker API (Metode GET)
         * @param {string} endpoint - Nama fungsi/endpoint (misal: 'getTotals')
         * @param {Object} queryParams - Objek parameter query {period: '2024-01'}
         */
        get: async (endpoint, queryParams = {}) => {
            const url = new URL(`${API_BASE_URL}/api/${endpoint}`);
            Object.keys(queryParams).forEach(key => url.searchParams.append(key, queryParams[key]));
            
            try {
                const response = await fetch(url.toString());
                if (!response.ok) {
                    throw new Error(`HTTP Error! Status: ${response.status}`);
                }
                const result = await response.json();
                if (result && result.success === false) {
                    throw new Error(result.message || "Operasi API Gagal.");
                }
                return result;
            } catch (error) {
                console.error(`API ${endpoint} Gagal:`, error);
                showNotification(`Gagal mengambil data dari server: ${error.message}`, true);
                return null;
            }
        },
        
        /**
         * Mengirim data ke Worker API (Metode POST/PATCH/DELETE)
         * @param {string} endpoint - Nama fungsi/endpoint (misal: 'addExpense')
         * @param {Object} data - Objek data yang dikirim (body)
         * @param {string} method - Metode HTTP ('POST', 'PATCH', 'DELETE')
         * @param {Object} queryParams - Parameter tambahan di URL (misal: {sheetName: 'Expenses', id: 10})
         */
        call: async (endpoint, data = {}, method = 'POST', queryParams = {}) => {
            const url = new URL(`${API_BASE_URL}/api/${endpoint}`);
            Object.keys(queryParams).forEach(key => url.searchParams.append(key, queryParams[key]));
            
            try {
                const response = await fetch(url.toString(), {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (!response.ok || (result && result.success === false)) {
                    const errorMessage = result?.message || `Operasi Gagal dengan status ${response.status}.`;
                    throw new Error(errorMessage);
                }
                
                return result;
            } catch (error) {
                console.error(`API ${endpoint} Gagal:`, error);
                showNotification(`Operasi gagal: ${error.message}`, true);
                return null;
            }
        }
    };

    // ----------------------------------------------------------------------
    // 3. UTILITY UI & HELPER
    // ----------------------------------------------------------------------

    function formatRupiah(number) {
        if (number === null || number === undefined || isNaN(number)) return 'Rp 0';
        const num = Math.abs(number); // Ambil nilai absolut
        const formatted = new Intl.NumberFormat('id-ID').format(num);
        const sign = number < 0 ? '- ' : '';
        return `Rp ${sign}${formatted}`;
    }

    function showNotification(message, isError = false) {
        const notif = document.getElementById('notification');
        notif.textContent = message;
        notif.style.backgroundColor = isError ? '#f44336' : var(--header-color);
        notif.classList.add('show');
        setTimeout(() => {
            notif.classList.remove('show');
        }, 3000);
    }

    function changeTab(tabName) {
      document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
      document.getElementById(tabName).style.display = 'block';
      document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));
      document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
      
      // Load data spesifik untuk tab
      if (tabName === 'dashboard') {
          loadAllDashboardData();
      } else if (tabName === 'transaction') {
          loadCategories(); // Pastikan kategori termuat untuk form
          loadAllTransactionData();
      } else if (tabName === 'chart') {
          loadAllChartData();
      }
    }
    
    function changeForm(formId) {
        document.getElementById('expense-form').style.display = 'none';
        document.getElementById('income-form').style.display = 'none';
        document.getElementById(formId).style.display = 'block';
        
        document.querySelector('.tab-nav button[data-form="expense-form"]').classList.remove('active');
        document.querySelector('.tab-nav button[data-form="income-form"]').classList.remove('active');
        document.querySelector(`.tab-nav button[data-form="${formId}"]`).classList.add('active');
    }
    
    function closeModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
    }

    function openModal(modalId) {
        document.getElementById(modalId).style.display = 'block';
    }
    
    function getTodayDate() {
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        const dd = String(today.getDate()).padStart(2, '0');
        return `${yyyy}-${mm}-${dd}`;
    }

    function getPeriodDisplay(period) {
        if (!period || period.length !== 7) return period;
        const [year, month] = period.split('-');
        const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
        return `${monthNames[parseInt(month) - 1]} ${year}`;
    }

    // ----------------------------------------------------------------------
    // 4. PERIOD MANAGEMENT
    // ----------------------------------------------------------------------

    function initializePeriod() {
        if (currentPeriod === '') {
            currentPeriod = getTodayDate().substring(0, 7);
        }
    }
    
    function updatePeriodDisplay(period, isTransTab = false, isBudgetTab = false) {
        const display = getPeriodDisplay(period);
        if (isTransTab) {
            document.getElementById('transPeriodDisplay').textContent = display;
        } else if (isBudgetTab) {
            document.getElementById('budgetPeriodDisplay').textContent = display;
        } else {
            document.getElementById('currentPeriodDisplay').textContent = display;
        }
    }

    function changePeriod(offset, isTransTab = false, isBudgetTab = false) {
        const [year, month] = currentPeriod.split('-').map(Number);
        let newMonth = month + offset;
        let newYear = year;

        if (newMonth > 12) {
            newMonth = 1;
            newYear += 1;
        } else if (newMonth < 1) {
            newMonth = 12;
            newYear -= 1;
        }
        
        currentPeriod = `${newYear}-${String(newMonth).padStart(2, '0')}`;
        updatePeriodDisplay(currentPeriod, isTransTab, isBudgetTab);

        if (isTransTab) {
             loadAllTransactionData();
        } else if (isBudgetTab) {
             loadBudgetTable();
        } else {
             loadAllDashboardData();
        }
    }
    
    // ----------------------------------------------------------------------
    // 5. DATA LOADING
    // ----------------------------------------------------------------------

    async function loadCategories() {
        const result = await api.get('getCategories');
        
        if (result) {
            allCategories = result;
            populateSelectOptions('expCategory', result.categories);
            populateSelectOptions('incSource', result.sources);
            populateSelectOptions('expAccount', result.accounts);
            populateSelectOptions('incAccount', result.accounts);
            
            // Juga muat untuk modal edit
            populateSelectOptions('editCategory', [...result.categories, ...result.sources]);
            populateSelectOptions('editAccount', result.accounts);
            
            // Muat data pengaturan
            renderSettingsLists(result.categories, result.sources, result.accounts);
        }
    }
    
    function populateSelectOptions(selectId, options) {
        const selectEl = document.getElementById(selectId);
        selectEl.innerHTML = '<option value="" disabled selected>Pilih...</option>';
        options.forEach(option => {
            const opt = document.createElement('option');
            opt.value = option;
            opt.textContent = option;
            selectEl.appendChild(opt);
        });
    }

    async function loadTotals() {
        const result = await api.get('getTotals', { period: currentPeriod });
        
        if (result) {
            document.getElementById('totalIncome').textContent = formatRupiah(result.totalIncome);
            document.getElementById('totalExpense').textContent = formatRupiah(result.totalExpense);
            
            const netBalanceEl = document.getElementById('netBalance');
            netBalanceEl.textContent = formatRupiah(result.netBalance);
            netBalanceEl.style.color = result.netBalance >= 0 ? var(--income-color) : var(--expense-color);
        }
    }
    
    async function loadAllTransactionData(isDashboard = false) {
        const result = await api.get('getTransactions', { period: currentPeriod });
        
        if (result) {
            renderTransactionList(result.expData, result.incData, isDashboard);
        }
    }

    function loadAllDashboardData() {
        updatePeriodDisplay(currentPeriod, false, false);
        loadTotals();
        loadAllTransactionData(true);
    }
    
    function loadAllChartData() {
        drawMonthlyChart();
        drawExpensePieChart();
        drawIncomePieChart();
        loadBudgetTable();
    }
    
    // ----------------------------------------------------------------------
    // 6. RENDER UI
    // ----------------------------------------------------------------------

    function renderTransactionList(expData, incData, isDashboard) {
        const allData = [...expData.map(d => ({ ...d, type: 'expense' })), 
                         ...incData.map(d => ({ ...d, type: 'income' }))];
        
        // Urutkan ulang: terbaru di atas (Tanggal ada di index 2)
        allData.sort((a, b) => new Date(b[2]) - new Date(a[2])); 

        const targetList = isDashboard ? document.getElementById('latestTransactionList') : document.getElementById('allTransactionList');
        targetList.innerHTML = '';
        
        const displayData = isDashboard ? allData.slice(0, 5) : allData;
        
        if (displayData.length === 0) {
            targetList.innerHTML = '<div class="trans-empty">Belum ada transaksi di periode ini.</div>';
            document.getElementById('transCountLabel').textContent = '';
            return;
        }

        displayData.forEach(item => {
            const [id, typeDisplay, date, categoryOrSource, account, amount, desc] = item;
            const isExpense = item.type === 'expense';
            const sheetName = isExpense ? 'Expenses' : 'Income';
            
            const itemEl = document.createElement('div');
            itemEl.className = `transaction-item trans-${item.type}`;
            itemEl.setAttribute('data-id', id); // ID transaksi (Row Index GAS lama, ID Supabase baru)
            itemEl.setAttribute('data-sheet', sheetName);
            itemEl.onclick = () => showEditModal(id, sheetName, date, categoryOrSource, account, amount, desc);

            itemEl.innerHTML = `
                <div class="trans-details">
                    <div class="trans-category">${categoryOrSource} (${account})</div>
                    <div class="trans-desc">${desc || 'Tidak ada deskripsi'}</div>
                    <div class="trans-date">${date}</div>
                </div>
                <div class="trans-amount">${formatRupiah(amount)}</div>
            `;
            targetList.appendChild(itemEl);
        });
        
        if (isDashboard) {
             document.getElementById('transCountLabel').textContent = `(${allData.length} total)`;
        }
    }
    
    // Chart Functions (Sederhana, hanya memanggil Google Charts)
    
    async function drawMonthlyChart() {
        const chartData = await api.get('getMonthlyChartData');
        
        if (chartData && chartData.length > 1) {
             google.charts.load('current', {packages:['corechart']});
             google.charts.setOnLoadCallback(() => {
                const data = google.visualization.arrayToDataTable(chartData);
                
                const opt = {
                    backgroundColor: chartBg,
                    legend: {position: 'bottom', textStyle: {color: chartText}},
                    hAxis: {textStyle: {color: chartText}},
                    vAxis: {textStyle: {color: chartText}, format: 'short'},
                    colors: [incomeColor, expenseColor, balanceColor],
                    seriesType: 'bars',
                    series: {2: {type: 'line', targetAxisIndex: 1, lineWidth: 3}}, // Saldo Bersih sebagai garis
                    chartArea: {left: '15%', right: '5%', top: '10%', bottom: '25%'}
                };
                new google.visualization.ComboChart(document.getElementById('chartMonthly')).draw(data, opt);
             });
        }
    }

    async function drawExpensePieChart() {
        const catData = await api.get('getExpenseByCategory', { period: currentPeriod });

        if (catData && catData.length > 1) {
            google.charts.load('current', {packages:['corechart']});
            google.charts.setOnLoadCallback(() => {
                const data = google.visualization.arrayToDataTable(catData);
                const schoolPalette = [expenseColor, balanceColor, incomeColor, '#FFD882', '#9ECF6C', '#4F4F4F', '#7A7A7A', '#C0C0C0']; 

                const opt = {
                    backgroundColor: chartBg,
                    legend: {position: 'right', textStyle: {color: chartText}},
                    pieHole: 0.3,
                    colors: schoolPalette 
                };
                new google.visualization.PieChart(document.getElementById('pieChartExpense')).draw(data, opt);
            });
        }
    }

    async function drawIncomePieChart() {
        const incData = await api.get('getIncomeBySource', { period: currentPeriod });

        if (incData && incData.length > 1) {
            google.charts.load('current', {packages:['corechart']});
            google.charts.setOnLoadCallback(() => {
                const data = google.visualization.arrayToDataTable(incData);
                const schoolPalette = [incomeColor, balanceColor, expenseColor, '#9ECF6C', '#FFD882', '#4F4F4F'];

                const opt = {
                    backgroundColor: chartBg,
                    legend: {position: 'right', textStyle: {color: chartText}},
                    pieHole: 0.3,
                    colors: schoolPalette
                };
                new google.visualization.PieChart(document.getElementById('pieChartIncome')).draw(data, opt);
            });
        }
    }
    
    async function loadBudgetTable() {
        updatePeriodDisplay(currentPeriod, false, true);
        const budgetData = await api.get('getBudgetByCategory', { period: currentPeriod });
        const container = document.getElementById('budgetTableContainer');
        container.innerHTML = '';
        
        if (!budgetData || budgetData.length === 0) {
            container.innerHTML = '<div class="trans-empty">Tidak ada kategori yang terdaftar. Tambahkan di Pengaturan.</div>';
            return;
        }

        let tableHTML = `<table class="budget-table">
            <thead>
                <tr>
                    <th>Kategori</th>
                    <th>Limit</th>
                    <th>Digunakan</th>
                    <th>Status</th>
                    <th>Aksi</th>
                </tr>
            </thead>
            <tbody>`;
            
        budgetData.forEach(item => {
            const percentage = item.limit > 0 ? (item.used / item.limit) * 100 : 0;
            let statusClass = 'ok';
            if (percentage > 100) {
                statusClass = 'over';
            } else if (percentage > 80) {
                statusClass = 'warning';
            }
            
            const fillWidth = Math.min(percentage, 100);

            tableHTML += `<tr>
                <td>${item.category}</td>
                <td>${formatRupiah(item.limit)}</td>
                <td>${formatRupiah(item.used)}</td>
                <td>
                    <div class="budget-status-bar">
                        <div class="budget-status-fill ${statusClass}" style="width: ${fillWidth}%;"></div>
                    </div>
                    <span style="font-size: 0.8em; opacity: 0.7;">${percentage.toFixed(0)}%</span>
                </td>
                <td>
                    <input type="number" class="budget-limit-input" value="${item.limit}" 
                           onchange="updateBudget('${item.category}', this.value)">
                </td>
            </tr>`;
        });

        tableHTML += `</tbody></table>`;
        container.innerHTML = tableHTML;
    }

    // ----------------------------------------------------------------------
    // 7. CRUD FUNCTIONS (Client Side)
    // ----------------------------------------------------------------------

    // Submitter Forms
    document.getElementById('expense-form').onsubmit = async (e) => {
        e.preventDefault();
        const btn = document.getElementById('expSubmitBtn');
        btn.disabled = true;
        
        const data = {
            date: document.getElementById('expDate').value,
            category: document.getElementById('expCategory').value,
            account: document.getElementById('expAccount').value,
            amount: document.getElementById('expAmount').value,
            desc: document.getElementById('expDesc').value,
        };

        const result = await api.call('addExpense', data);
        
        btn.disabled = false;
        if (result && result.success) {
            showNotification(result.message);
            document.getElementById('expense-form').reset();
            loadAllDashboardData();
            loadAllTransactionData(false);
        }
    };

    document.getElementById('income-form').onsubmit = async (e) => {
        e.preventDefault();
        const btn = document.getElementById('incSubmitBtn');
        btn.disabled = true;
        
        const data = {
            date: document.getElementById('incDate').value,
            source: document.getElementById('incSource').value,
            account: document.getElementById('incAccount').value,
            amount: document.getElementById('incAmount').value,
            desc: document.getElementById('incDesc').value,
        };

        const result = await api.call('addIncome', data);
        
        btn.disabled = false;
        if (result && result.success) {
            showNotification(result.message);
            document.getElementById('income-form').reset();
            loadAllDashboardData();
            loadAllTransactionData(false);
        }
    };
    
    // Modal Edit/Update
    function showEditModal(id, sheetName, date, categoryOrSource, account, amount, desc) {
        document.getElementById('modalTitle').textContent = `Edit ${sheetName === 'Expenses' ? 'Pengeluaran' : 'Pemasukan'}`;
        document.getElementById('editTransId').value = id;
        document.getElementById('editTransSheetName').value = sheetName;
        document.getElementById('editDate').value = date;
        document.getElementById('editAmount').value = amount;
        document.getElementById('editDesc').value = desc;
        
        // Atur nilai default select
        const categorySelect = document.getElementById('editCategory');
        categorySelect.value = categoryOrSource;
        const accountSelect = document.getElementById('editAccount');
        accountSelect.value = account;
        
        openModal('editModal');
    }
    
    document.getElementById('editTransactionForm').onsubmit = async (e) => {
        e.preventDefault();
        const id = document.getElementById('editTransId').value;
        const sheetName = document.getElementById('editTransSheetName').value;
        
        // Data yang dikirim ke Worker: {date, category, account, amount, desc}
        const values = {
            date: document.getElementById('editDate').value,
            category: document.getElementById('editCategory').value,
            account: document.getElementById('editAccount').value,
            amount: document.getElementById('editAmount').value,
            desc: document.getElementById('editDesc').value
        };

        const result = await api.call('updateTransaction', values, 'PATCH', { sheetName: sheetName, id: id });
        
        if (result && result.success) {
            showNotification("Transaksi berhasil diperbarui.");
            closeModal('editModal');
            loadAllDashboardData();
            loadAllTransactionData(false);
        }
    };

    async function deleteTransaction() {
        if (!confirm("Anda yakin ingin menghapus transaksi ini?")) return;
        
        const id = document.getElementById('editTransId').value;
        const sheetName = document.getElementById('editTransSheetName').value;

        // Metode DELETE ke endpoint /api/deleteTransaction
        const result = await api.call('deleteTransaction', {}, 'DELETE', { sheetName: sheetName, id: id });
        
        if (result && result.success) {
            showNotification("Transaksi berhasil dihapus.");
            closeModal('editModal');
            loadAllDashboardData();
            loadAllTransactionData(false);
        }
    }
    
    // Budget Update
    async function updateBudget(category, limit) {
        const data = {
            period: currentPeriod,
            category: category,
            limit: limit
        };
        
        const result = await api.call('updateBudgetByCategory', data);
        if (result && result.success) {
            showNotification(result.message);
            loadBudgetTable();
        }
    }

    // Settings Functions
    function renderSettingsLists(categories, sources, accounts) {
        const renderList = (listId, items, type) => {
            const ul = document.getElementById(listId);
            ul.innerHTML = '';
            items.forEach(item => {
                const li = document.createElement('li');
                li.className = 'settings-list-item';
                li.innerHTML = `
                    <span>${item}</span>
                    <button onclick="deleteSetting('${type}', '${item}')">Hapus</button>
                `;
                ul.appendChild(li);
            });
        };
        
        renderList('expenseCategoryList', categories, 'Expense');
        renderList('incomeSourceList', sources, 'Income');
        renderList('accountList', accounts, 'Account');
    }

    async function addCategory(type) {
        const inputId = type === 'Expense' ? 'newExpCategory' : 'newIncSource';
        const name = document.getElementById(inputId).value.trim();
        if (name === '') return;

        const result = await api.call('addCategory', { type: type, name: name });
        if (result) {
            showNotification(`${type} ${name} berhasil ditambahkan.`);
            document.getElementById(inputId).value = '';
            loadCategories(); // Muat ulang semua data
        }
    }

    async function deleteSetting(type, name) {
        if (!confirm(`Anda yakin ingin menghapus ${type} "${name}"? Ini mungkin mengganggu transaksi lama.`)) return;

        let result = null;
        if (type === 'Account') {
            result = await api.call('deleteAccount', { name: name }, 'DELETE');
        } else {
            result = await api.call('deleteCategory', { type: type, name: name }, 'DELETE');
        }

        if (result) {
            showNotification(`${type} ${name} berhasil dihapus.`);
            loadCategories();
            // Tidak perlu load dashboard/transaksi, Supabase sudah menangani.
        }
    }

    async function addAccount() {
        const name = document.getElementById('newAccountName').value.trim();
        if (name === '') return;

        const result = await api.call('addAccount', { name: name });
        if (result) {
            showNotification(`Akun ${name} berhasil ditambahkan.`);
            document.getElementById('newAccountName').value = '';
            loadCategories();
        }
    }
    
    function openSettingsModal() {
        loadCategories(); // Pastikan list pengaturan terupdate
        openModal('settingsModal');
    }
    
    // ----------------------------------------------------------------------
    // 8. INITIALIZATION
    // ----------------------------------------------------------------------

    function init() {
        // Set tanggal hari ini di form
        document.getElementById('expDate').value = getTodayDate();
        document.getElementById('incDate').value = getTodayDate();
        
        initializePeriod();
        loadCategories();
        loadAllDashboardData();
    }
    
    // Event listener untuk menutup modal saat klik di luar area
    window.onclick = function(event) {
        if (event.target == document.getElementById('editModal')) {
            closeModal('editModal');
        }
        if (event.target == document.getElementById('settingsModal')) {
            closeModal('settingsModal');
        }
    }

    // Jalankan inisialisasi
    init();

  </script>
</body>
</html>
