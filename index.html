<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="utf-8">
    <title>Budgetin - Aplikasi Pencatatan Keuangan</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    
    <script>
        // Ganti dengan URL Web App Apps Script Anda yang panjang (e.g., script.google.com/macros/s/...)
        const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxc3si9BQnwNCFP1WVK0wrpaAWNQVbxtgxKeMxt5qvD2HtIK-UFM3vsomH8xkzLCIQw1Q/exec";

        // Cek apakah halaman dimuat di dalam domain Apps Script
        if (window.location.host !== 'script.google.com' && !window.location.host.includes('googleusercontent.com')) {
            // Jika tidak berada di lingkungan Apps Script (berarti di GitHub Pages), lakukan pengalihan
            window.location.replace(APPS_SCRIPT_URL);
        }
        // Jika berada di Apps Script, biarkan kode aplikasi dimuat.
    </script>
    
    <style>
        :root {
            --primary-color: #7CD18B;
            --secondary-color: #38a169;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --bg-color: #f8f9fa;
            --text-color: #333;
        }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background-color: var(--bg-color); color: var(--text-color); }
        .container { max-width: 900px; margin: 20px auto; padding: 0 15px; }
        header { background-color: var(--primary-color); color: white; padding: 15px 0; text-align: center; margin-bottom: 20px; }
        nav { background-color: #fff; padding: 10px 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        nav button { background: none; border: none; padding: 10px 15px; cursor: pointer; font-size: 16px; transition: background-color 0.3s; }
        nav button.active { background-color: var(--secondary-color); color: white; border-radius: 4px; }
        nav button:hover:not(.active) { background-color: #f0f0f0; }
        
        .content-section { display: none; padding: 20px 0; }
        .content-section.active { display: block; }
        
        /* Dashboard Cards */
        .card-container { display: flex; gap: 20px; margin-bottom: 20px; }
        .card { flex: 1; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .card h4 { margin-top: 0; font-size: 1.1em; }
        .card p { font-size: 2em; margin: 5px 0 0; font-weight: bold; }
        .card-income { background-color: #e6f7ea; color: var(--secondary-color); }
        .card-expense { background-color: #fde8e8; color: var(--danger-color); }
        .card-balance { background-color: #fff; border-left: 5px solid var(--primary-color); }
        
        /* Forms */
        form { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        button[type="submit"] { background-color: var(--primary-color); color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; transition: background-color 0.3s; }
        button[type="submit"]:hover { background-color: var(--secondary-color); }
        
        /* Table */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; background-color: #fff; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; font-weight: 600; }
        .table-actions button { margin-right: 5px; background: none; border: none; cursor: pointer; color: var(--danger-color); }

        /* Budget and Settings Specific */
        #budgetList, #settingsList { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .budget-item, .setting-item { background-color: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border-left: 4px solid var(--warning-color); }
        .budget-item h5 { margin-top: 0; display: flex; justify-content: space-between; align-items: center; }
        .budget-item input[type="number"] { width: 100px; padding: 5px; }
        .setting-item button { margin-left: 10px; color: var(--danger-color); }
        
        /* Alerts */
        .alert { padding: 15px; margin-bottom: 20px; border-radius: 4px; font-weight: bold; }
        .alert-success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }

    </style>
</head>
<body>
    <header>
        <h1>Budgetin üí∞</h1>
        <p id="currentPeriodDisplay">Memuat...</p>
    </header>

    <nav class="container">
        <button id="navDashboard" class="active">Dashboard</button>
        <button id="navTransaction">Transaksi</button>
        <button id="navBudget">Budget</button>
        <button id="navSettings">Pengaturan</button>
    </nav>

    <main class="container">
        <section id="dashboardSection" class="content-section active">
            <h2>Ringkasan Keuangan</h2>
            <div class="card-container">
                <div class="card card-income">
                    <h4>Total Pemasukan</h4>
                    <p id="totalIncome">Rp0</p>
                </div>
                <div class="card card-expense">
                    <h4>Total Pengeluaran</h4>
                    <p id="totalExpense">Rp0</p>
                </div>
                <div class="card card-balance">
                    <h4>Saldo Bersih</h4>
                    <p id="netBalance">Rp0</p>
                </div>
            </div>
            
            <div style="margin-bottom: 20px; background-color: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                <h3>Tren Saldo Bulanan</h3>
                <div id="chartMonthly" style="height: 300px;"></div>
            </div>

            <div style="display: flex; gap: 20px;">
                <div style="flex: 1; background-color: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                    <h3>Pengeluaran per Kategori</h3>
                    <div id="chartExpense" style="height: 300px;"></div>
                </div>
                <div style="flex: 1; background-color: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                    <h3>Pemasukan per Sumber</h3>
                    <div id="chartIncome" style="height: 300px;"></div>
                </div>
            </div>
        </section>

        <section id="transactionSection" class="content-section">
            <h2>Catat Transaksi</h2>
            <div id="transactionAlert" class="alert" style="display: none;"></div>
            
            <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                <form id="expenseForm" style="flex: 1;">
                    <h3>‚ûï Pengeluaran</h3>
                    <div class="form-group"><label>Tanggal</label><input type="date" name="date" required></div>
                    <div class="form-group"><label>Kategori</label><select name="category" id="expenseCategorySelect" required></select></div>
                    <div class="form-group"><label>Akun</label><select name="account" id="expenseAccountSelect" required></select></div>
                    <div class="form-group"><label>Jumlah (Rp)</label><input type="number" name="amount" min="1" required></div>
                    <div class="form-group"><label>Deskripsi (Opsional)</label><textarea name="description"></textarea></div>
                    <button type="submit">Catat Pengeluaran</button>
                </form>

                <form id="incomeForm" style="flex: 1;">
                    <h3>üí∞ Pemasukan</h3>
                    <div class="form-group"><label>Tanggal</label><input type="date" name="date" required></div>
                    <div class="form-group"><label>Sumber</label><select name="source" id="incomeSourceSelect" required></select></div>
                    <div class="form-group"><label>Akun</label><select name="account" id="incomeAccountSelect" required></select></div>
                    <div class="form-group"><label>Jumlah (Rp)</label><input type="number" name="amount" min="1" required></div>
                    <div class="form-group"><label>Deskripsi (Opsional)</label><textarea name="description"></textarea></div>
                    <button type="submit">Catat Pemasukan</button>
                </form>
            </div>
            
            <h3>Daftar Transaksi Bulan Ini</h3>
            <table id="transactionTable">
                <thead>
                    <tr><th>Tipe</th><th>Tanggal</th><th>Kategori/Sumber</th><th>Akun</th><th>Jumlah</th><th>Deskripsi</th><th>Aksi</th></tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </section>
        
        <section id="budgetSection" class="content-section">
            <h2>Pengaturan Budget</h2>
            <div id="budgetAlert" class="alert" style="display: none;"></div>
            <p>Atur batas pengeluaran (budget) untuk setiap kategori pada periode <span id="budgetPeriodDisplay" style="font-weight: bold;"></span>.</p>
            
            <div id="budgetList">
                </div>
            <button onclick="saveAllBudgets()">Simpan Semua Budget</button>

            <h3>Status Budget Bulan Ini</h3>
            <table id="budgetStatusTable">
                <thead>
                    <tr><th>Kategori</th><th>Budget Limit</th><th>Pengeluaran Saat Ini</th><th>Sisa Budget</th></tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </section>

        <section id="settingsSection" class="content-section">
            <h2>Pengaturan Aplikasi</h2>
            <div id="settingsAlert" class="alert" style="display: none;"></div>
            
            <div id="settingsList" style="display: flex; gap: 20px;">
                <div style="flex: 1;">
                    <h3>Kategori Pengeluaran</h3>
                    <form id="addExpenseCatForm" style="margin-bottom: 15px; padding: 10px;">
                        <input type="text" name="name" placeholder="Nama Kategori Baru" required>
                        <button type="submit">Tambah</button>
                    </form>
                    <ul id="expenseCategoryList" style="list-style: none; padding: 0;"></ul>
                </div>

                <div style="flex: 1;">
                    <h3>Sumber Pemasukan</h3>
                    <form id="addIncomeSourceForm" style="margin-bottom: 15px; padding: 10px;">
                        <input type="text" name="name" placeholder="Nama Sumber Baru" required>
                        <button type="submit">Tambah</button>
                    </form>
                    <ul id="incomeSourceList" style="list-style: none; padding: 0;"></ul>
                </div>
                
                <div style="flex: 1;">
                    <h3>Akun Bank/Dompet</h3>
                    <form id="addAccountForm" style="margin-bottom: 15px; padding: 10px;">
                        <input type="text" name="name" placeholder="Nama Akun Baru" required>
                        <button type="submit">Tambah</button>
                    </form>
                    <ul id="accountList" style="list-style: none; padding: 0;"></ul>
                </div>
            </div>
        </section>

    </main>
    
    <div id="editModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000;">
        <div style="background:#fff; margin:10% auto; padding:20px; width:400px; border-radius:8px;">
            <h3>Edit Transaksi</h3>
            <form id="editForm">
                <input type="hidden" name="sheetName" id="editSheetName">
                <input type="hidden" name="rowIndex" id="editRowIndex">
                <div id="editAlert" class="alert" style="display: none;"></div>

                <div class="form-group"><label>Tanggal</label><input type="date" name="date" id="editDate" required></div>
                <div class="form-group"><label id="categoryOrSourceLabel"></label><select name="categoryOrSource" id="editCategoryOrSource" required></select></div>
                <div class="form-group"><label>Akun</label><select name="account" id="editAccount" required></select></div>
                <div class="form-group"><label>Jumlah (Rp)</label><input type="number" name="amount" id="editAmount" min="1" required></div>
                <div class="form-group"><label>Deskripsi (Opsional)</label><textarea name="description" id="editDescription"></textarea></div>
                
                <button type="submit">Simpan Perubahan</button>
                <button type="button" onclick="closeEditModal()">Batal</button>
            </form>
        </div>
    </div>
    
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

    <script>
        // =====================================================================
        // JAVASCRIPT APLIKASI UTAMA (FRONTEND)
        // =====================================================================

        // Variabel Global
        const currentPeriod = new Date().toISOString().substring(0, 7); // YYYY-MM
        let allCategories = { categories: [], sources: [] };
        let allAccounts = [];
        
        // Inisialisasi Google Charts
        google.charts.load('current', {'packages':['corechart', 'line']});
        google.charts.setOnLoadCallback(initApp);

        function initApp() {
            document.getElementById('currentPeriodDisplay').innerText = formatPeriod(currentPeriod);
            document.getElementById('budgetPeriodDisplay').innerText = formatPeriod(currentPeriod);
            
            loadData();
            setupEventListeners();
        }

        // --- UTILITY FUNCTIONS ---

        function formatPeriod(period) {
            const [year, month] = period.split('-');
            const date = new Date(year, month - 1, 1);
            return date.toLocaleDateString('id-ID', { month: 'long', year: 'numeric' });
        }

        function formatCurrency(number) {
            return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(number);
        }

        function showAlert(type, message, elementId) {
            const el = document.getElementById(elementId);
            el.className = `alert alert-${type}`;
            el.innerText = message;
            el.style.display = 'block';
            setTimeout(() => { el.style.display = 'none'; }, 5000);
        }

        // --- DATA LOADERS ---

        function loadData() {
            // Dashboard & Transaction Data
            google.script.run
                .withSuccessHandler(renderDashboard)
                .getTotals(currentPeriod);

            google.script.run
                .withSuccessHandler(renderTransactions)
                .getTransactions(currentPeriod);

            // Chart Data
            google.script.run
                .withSuccessHandler(drawExpenseChart)
                .getExpenseByCategory(currentPeriod);

            google.script.run
                .withSuccessHandler(drawIncomeChart)
                .getIncomeBySource(currentPeriod);
                
            google.script.run
                .withSuccessHandler(drawMonthlyChart)
                .getMonthlyChartData();

            // Settings & Form Data
            google.script.run
                .withSuccessHandler(setupFormsAndSettings)
                .getCategories();
            
            google.script.run
                .withSuccessHandler(setupAccounts)
                .getAccounts();

            // Budget Data
            google.script.run
                .withSuccessHandler(renderBudgetSection)
                .getBudgetByCategory(currentPeriod);
        }

        function setupFormsAndSettings(data) {
            allCategories = data;
            
            const expCatSelects = document.querySelectorAll('#expenseCategorySelect, #editCategoryOrSource');
            const incSourceSelects = document.querySelectorAll('#incomeSourceSelect, #editCategoryOrSource');

            expCatSelects.forEach(select => {
                if (select.id === 'expenseCategorySelect') select.innerHTML = '';
            });
            incSourceSelects.forEach(select => {
                if (select.id === 'incomeSourceSelect') select.innerHTML = '';
            });

            // Populate Expense Categories
            data.categories.forEach(cat => {
                expCatSelects.forEach(select => {
                    if (select.id === 'expenseCategorySelect') {
                         select.innerHTML += `<option value="${cat}">${cat}</option>`;
                    }
                });
            });
            renderSettingsList('expenseCategoryList', data.categories, 'Expense');


            // Populate Income Sources
            data.sources.forEach(src => {
                incSourceSelects.forEach(select => {
                    if (select.id === 'incomeSourceSelect') {
                        select.innerHTML += `<option value="${src}">${src}</option>`;
                    }
                });
            });
            renderSettingsList('incomeSourceList', data.sources, 'Income');

            // Set default date to today
            const today = new Date().toISOString().substring(0, 10);
            document.querySelectorAll('input[type="date"]').forEach(input => {
                if (!input.value) input.value = today;
            });
        }
        
        function setupAccounts(accounts) {
            allAccounts = accounts;
            const accountSelects = document.querySelectorAll('#expenseAccountSelect, #incomeAccountSelect, #editAccount');
            
            accountSelects.forEach(select => {
                select.innerHTML = '';
                accounts.forEach(acc => {
                    select.innerHTML += `<option value="${acc}">${acc}</option>`;
                });
            });
            
            renderSettingsList('accountList', accounts, 'Account');
        }

        // --- RENDERERS ---

        function renderDashboard(totals) {
            document.getElementById('totalIncome').innerText = formatCurrency(totals.totalIncome);
            document.getElementById('totalExpense').innerText = formatCurrency(totals.totalExpense);
            document.getElementById('netBalance').innerText = formatCurrency(totals.netBalance);
            
            // Re-render budget section (status table depends on totals)
            google.script.run
                .withSuccessHandler(renderBudgetSection)
                .getBudgetByCategory(currentPeriod);
        }

        function renderTransactions(data) {
            const tableBody = document.getElementById('transactionTable').querySelector('tbody');
            tableBody.innerHTML = '';
            
            const allTransactions = [...data.expData, ...data.incData];
            allTransactions.sort((a, b) => new Date(b[2]) - new Date(a[2])); // Sort by date descending
            
            allTransactions.forEach(t => {
                const [rowIndex, type, date, categoryOrSource, account, amount, description] = t;
                const sheetName = type === 'Expense' ? 'Expenses' : 'Income';
                
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${type}</td>
                    <td>${date}</td>
                    <td>${categoryOrSource}</td>
                    <td>${account}</td>
                    <td style="text-align: right;">${formatCurrency(amount)}</td>
                    <td>${description}</td>
                    <td class="table-actions">
                        <button onclick="openEditModal('${sheetName}', ${rowIndex}, '${date}', '${categoryOrSource}', '${account}', ${amount}, '${description}')">‚úèÔ∏è</button>
                        <button onclick="deleteRow('${sheetName}', ${rowIndex})">‚ùå</button>
                    </td>
                `;
            });
        }

        function renderBudgetSection(budgetData) {
            const budgetListEl = document.getElementById('budgetList');
            const budgetStatusBody = document.getElementById('budgetStatusTable').querySelector('tbody');
            
            budgetListEl.innerHTML = '';
            budgetStatusBody.innerHTML = '';

            const currentExpenseMap = {};
            // Re-fetch expense data for current period to calculate status
            google.script.run.withSuccessHandler(chartData => {
                chartData.slice(1).forEach(([category, amount]) => {
                    currentExpenseMap[category] = amount;
                });

                budgetData.forEach(item => {
                    // Render Budget List Form
                    budgetListEl.innerHTML += `
                        <div class="budget-item">
                            <h5>${item.category}</h5>
                            <div class="form-group" style="display: flex; gap: 10px; align-items: center;">
                                <label>Limit (Rp)</label>
                                <input type="number" id="budgetLimit_${item.category.replace(/\s/g, '_')}" data-category="${item.category}" value="${item.limit}" min="0" style="flex-grow: 1;">
                            </div>
                        </div>
                    `;

                    // Render Budget Status Table Row
                    const currentExpense = currentExpenseMap[item.category] || 0;
                    const limit = item.limit || 0;
                    const remaining = limit - currentExpense;
                    
                    const row = budgetStatusBody.insertRow();
                    row.innerHTML = `
                        <td>${item.category}</td>
                        <td style="text-align: right;">${formatCurrency(limit)}</td>
                        <td style="text-align: right;">${formatCurrency(currentExpense)}</td>
                        <td style="text-align: right; color: ${remaining < 0 ? 'var(--danger-color)' : 'var(--secondary-color)'}; font-weight: bold;">${formatCurrency(remaining)}</td>
                    `;
                });
            }).getExpenseByCategory(currentPeriod);
        }

        function renderSettingsList(ulId, items, type) {
            const ul = document.getElementById(ulId);
            ul.innerHTML = '';
            items.forEach(item => {
                ul.innerHTML += `
                    <li class="setting-item">
                        ${item}
                        <button onclick="deleteSetting('${type}', '${item}')">‚ùå</button>
                    </li>
                `;
            });
        }


        // --- CHART DRAWERS ---

        function drawChart(elementId, chartData, title, type = 'PieChart') {
            const data = google.visualization.arrayToDataTable(chartData);
            const options = {
                title: title,
                is3D: true,
                legend: { position: 'bottom' },
                chartArea: { width: '90%', height: '80%' }
            };
            
            const chart = new google.visualization[type](document.getElementById(elementId));
            chart.draw(data, options);
        }

        function drawExpenseChart(chartData) {
            drawChart('chartExpense', chartData, `Pengeluaran Bulan Ini: ${formatPeriod(currentPeriod)}`);
        }
        
        function drawIncomeChart(chartData) {
            drawChart('chartIncome', chartData, `Pemasukan Bulan Ini: ${formatPeriod(currentPeriod)}`);
        }
        
        function drawMonthlyChart(chartData) {
            const data = google.visualization.arrayToDataTable(chartData);
            const options = {
                title: 'Tren Saldo (Pemasukan vs Pengeluaran)',
                curveType: 'function',
                legend: { position: 'bottom' },
                vAxis: { format: 'currency' }
            };

            const chart = new google.visualization.LineChart(document.getElementById('chartMonthly'));
            chart.draw(data, options);
        }

        // --- EVENT HANDLERS ---
        
        function setupEventListeners() {
            // Navigation
            document.querySelectorAll('nav button').forEach(button => {
                button.addEventListener('click', () => {
                    document.querySelectorAll('nav button').forEach(btn => btn.classList.remove('active'));
                    document.querySelectorAll('.content-section').forEach(sec => sec.classList.remove('active'));
                    
                    button.classList.add('active');
                    document.getElementById(button.id.replace('nav', '').toLowerCase() + 'Section').classList.add('active');
                    
                    // Reload data only when necessary
                    if (button.id === 'navDashboard' || button.id === 'navBudget') {
                        loadData(); 
                    }
                });
            });

            // Transaction Forms
            document.getElementById('expenseForm').addEventListener('submit', handleAddExpense);
            document.getElementById('incomeForm').addEventListener('submit', handleAddIncome);
            
            // Settings Forms
            document.getElementById('addExpenseCatForm').addEventListener('submit', e => handleAddSetting(e, 'Expense'));
            document.getElementById('addIncomeSourceForm').addEventListener('submit', e => handleAddSetting(e, 'Income'));
            document.getElementById('addAccountForm').addEventListener('submit', e => handleAddSetting(e, 'Account'));
            
            // Edit Form
            document.getElementById('editForm').addEventListener('submit', handleEditTransaction);
        }
        
        // --- APPS SCRIPT CALLS (Action Handlers) ---
        
        function handleAddExpense(e) {
            e.preventDefault();
            const form = e.target;
            const data = {
                date: form.date.value,
                category: form.category.value,
                account: form.account.value,
                amount: form.amount.value,
                description: form.description.value
            };
            
            google.script.run
                .withSuccessHandler(res => {
                    showAlert(res.success ? 'success' : 'error', res.message, 'transactionAlert');
                    if (res.success) {
                        form.reset();
                        loadData(); // Refresh all data
                    }
                })
                .addExpense(data.date, data.category, data.account, data.amount, data.description);
        }

        function handleAddIncome(e) {
            e.preventDefault();
            const form = e.target;
            const data = {
                date: form.date.value,
                source: form.source.value,
                account: form.account.value,
                amount: form.amount.value,
                description: form.description.value
            };
            
            google.script.run
                .withSuccessHandler(res => {
                    showAlert(res.success ? 'success' : 'error', res.message, 'transactionAlert');
                    if (res.success) {
                        form.reset();
                        loadData(); // Refresh all data
                    }
                })
                .addIncome(data.date, data.source, data.account, data.amount, data.description);
        }
        
        function deleteRow(sheetName, rowIndex) {
            if (confirm(`Yakin ingin menghapus transaksi di ${sheetName} baris ${rowIndex}?`)) {
                google.script.run
                    .withSuccessHandler(res => {
                        showAlert(res.success ? 'success' : 'error', res.message, 'transactionAlert');
                        loadData(); // Refresh all data
                    })
                    .deleteTransaction(sheetName, rowIndex);
            }
        }
        
        function saveAllBudgets() {
            const budgetItems = document.querySelectorAll('#budgetList input[type="number"]');
            let promises = [];
            let updateCount = 0;

            budgetItems.forEach(input => {
                const category = input.getAttribute('data-category');
                const limit = input.value;
                if (limit !== '' && parseFloat(limit) >= 0) {
                     promises.push(new Promise((resolve, reject) => {
                         google.script.run
                            .withSuccessHandler(res => { resolve(res); })
                            .withFailureHandler(err => { reject(err); })
                            .updateBudgetByCategory(currentPeriod, category, limit);
                         updateCount++;
                     }));
                }
            });
            
            if (updateCount === 0) {
                 showAlert('warning', 'Tidak ada perubahan budget yang disimpan.', 'budgetAlert');
                 return;
            }

            Promise.all(promises).then(() => {
                showAlert('success', `${updateCount} Budget berhasil disimpan!`, 'budgetAlert');
                loadData(); // Refresh status
            }).catch(err => {
                showAlert('error', 'Gagal menyimpan budget: ' + err, 'budgetAlert');
            });
        }

        function handleAddSetting(e, type) {
            e.preventDefault();
            const form = e.target;
            const name = form.name.value.trim();
            
            const successHandler = res => {
                showAlert(res.success ? 'success' : 'error', res.message, 'settingsAlert');
                if (res.success) {
                    form.reset();
                    if (type === 'Account') {
                        google.script.run.withSuccessHandler(setupAccounts).getAccounts();
                    } else {
                        google.script.run.withSuccessHandler(setupFormsAndSettings).getCategories();
                    }
                }
            };
            
            if (type === 'Account') {
                google.script.run.withSuccessHandler(successHandler).addAccount(name);
            } else {
                google.script.run.withSuccessHandler(successHandler).addCategory(type, name);
            }
        }
        
        function deleteSetting(type, name) {
            if (confirm(`Yakin ingin menghapus ${type} "${name}"? Ini mungkin mempengaruhi data yang sudah ada.`)) {
                const successHandler = res => {
                    showAlert(res.success ? 'success' : 'error', res.message, 'settingsAlert');
                    if (res.success) {
                        if (type === 'Account') {
                            google.script.run.withSuccessHandler(setupAccounts).getAccounts();
                        } else {
                            google.script.run.withSuccessHandler(setupFormsAndSettings).getCategories();
                        }
                    }
                };

                if (type === 'Account') {
                    google.script.run.withSuccessHandler(successHandler).deleteAccount(name);
                } else {
                    google.script.run.withSuccessHandler(successHandler).deleteCategory(type, name);
                }
            }
        }

        // --- MODAL & EDIT FUNCTIONS ---

        function openEditModal(sheetName, rowIndex, date, categoryOrSource, account, amount, description) {
            document.getElementById('editSheetName').value = sheetName;
            document.getElementById('editRowIndex').value = rowIndex;
            document.getElementById('editDate').value = date;
            document.getElementById('editAmount').value = amount;
            document.getElementById('editDescription').value = description;
            document.getElementById('editAccount').value = account;
            
            const categoryOrSourceSelect = document.getElementById('editCategoryOrSource');
            categoryOrSourceSelect.innerHTML = '';
            
            document.getElementById('categoryOrSourceLabel').innerText = sheetName === 'Expenses' ? 'Kategori' : 'Sumber';
            
            const list = sheetName === 'Expenses' ? allCategories.categories : allCategories.sources;
            list.forEach(item => {
                categoryOrSourceSelect.innerHTML += `<option value="${item}">${item}</option>`;
            });
            categoryOrSourceSelect.value = categoryOrSource;
            
            document.getElementById('editModal').style.display = 'block';
        }
        
        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
            document.getElementById('editAlert').style.display = 'none';
        }
        
        function handleEditTransaction(e) {
            e.preventDefault();
            const form = e.target;
            const sheetName = form.sheetName.value;
            const rowIndex = form.rowIndex.value;
            
            const values = [
                form.date.value,
                form.categoryOrSource.value,
                form.account.value,
                form.amount.value,
                form.description.value
            ];
            
            google.script.run
                .withSuccessHandler(res => {
                    showAlert(res.success ? 'success' : 'error', res.message, 'editAlert');
                    if (res.success) {
                        closeEditModal();
                        loadData(); // Refresh data setelah edit
                    }
                })
                .updateTransaction(sheetName, rowIndex, values);
        }
    </script>
</body>
</html>
